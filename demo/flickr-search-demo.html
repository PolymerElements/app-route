<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../paper-spinner/paper-spinner.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../carbon-location.html">
<link rel="import" href="../carbon-route.html">

<dom-module id="flickr-search-page">
  <template>
    <style>
      paper-spinner {
        display: block;
      }
      img {
        max-width: 200px;
        max-height: 200px;
      }
    </style>
    <carbon-route pattern="/" route="{{route}}" query-params="{{queryParams}}">
    </carbon-route>
    <paper-input autofocus value="{{queryParams.search}}" label="Search the public domain on Flickr">
    </paper-input>

    <iron-ajax auto url="https://www.flickr.com/services/rest/"
               handle-as="json"
               debounce-duration="300"
               params="{{params}}"
               last-response="{{response}}"
               last-error="{{error}}"
               loading="{{loading}}">
    </iron-ajax>
    <paper-spinner active="{{loading}}"></paper-spinner>
    <template is="dom-repeat" items="{{response.photos.photo}}" as="photo">
      <a href="{{_computeLink(photo)}}">
        <img src="{{_computeSrc(photo)}}">
      </a>
    </template>
    <template is="dom-if" if="{{error}}">
      <span>{{error.statusCode}}</span> Error:
      <pre>{{error.response}}</pre>
    </template>
  </template>
  <script>
    Polymer({
      is: 'flickr-search-page',
      properties: {
        apiKey: {
          type: String,
        },

        params: {
          type: Object,
          computed: '_computeParams(apiKey, queryParams.search)'
        },

        selected: {
          type: Boolean,
          observer: '_selectedChanged'
        }
      },

      observers: [
        '_clearOldSearchResults(queryParams.search)'
      ],

      _clearOldSearchResults: function() {
        this.response = null;
      },

      _computeParams: function(apiKey, search) {
        return {
          method: 'flickr.photos.search',
          api_key: apiKey,
          text: search,
          license: '7,8',
          format: 'json',
          nojsoncallback: 1
        };
      },

      _computeSrc: function(photo) {
        if (!photo || !photo.farm) {
          return '';
        }
        return 'https://farm' + photo.farm + '.staticflickr.com/' +
            photo.server + '/' + photo.id + '_' + photo.secret + '.jpg';
      },

      _computeLink: function(photo) {
        return window.location.pathname + '#/image/' + photo.farm + '/' +
            photo.server + '/' + photo.id + '/' + photo.secret;
      },

      _selectedChanged: function(newVal, oldVal) {
        this.async(function() {
          if (newVal && !this.queryParams.search) {
            this.set('queryParams.search', 'spaceship')
          }
        });
      }
    })
  </script>
</dom-module>

<dom-module id="flickr-image-page">
  <template>
    <style>
      paper-spinner {
        display: block;
      }
      .tags span {
        display: inline-block;
        padding-right: 10px;
        font-size: 110%;
      }
      .tags span::after {
        content: ', ';
      }
      .tags span:last-of-type::after {
        content: '';
      }
    </style>
    <carbon-route route="{{route}}" pattern="/:farm/:server/:id/:secret" data="{{data}}">
    </carbon-route>
    <img src="{{_computeSrc(data)}}">
    <iron-ajax auto url="https://www.flickr.com/services/rest/"
               handle-as="json"
               params="{{params}}"
               last-response="{{metadata}}"
               last-error="{{error}}"
               loading="{{loading}}">
    </iron-ajax>
    <paper-spinner active="{{loading}}"></paper-spinner>
    <div>
      <h1>{{metadata.photo.title._content}}</h1>
      <div class="tags">
      <template is="dom-repeat" items="{{metadata.photo.tags.tag}}">
        <span>{{item.raw}}</span>
      </template>
      </div>
      <div>
        <ul>
          <template is="dom-repeat" items="{{metadata.photo.urls.url}}">
            <li>
              <a target="_blank" href="{{item._content}}">
                {{item._content}}
              </a>
            </li>
          </template>
        </ul>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'flickr-image-page',
      properties: {
        apiKey: {
          type: String,
        },

        params: {
          type: Object,
          computed: '_computeParams(apiKey, data.id, data.secret)'
        }

      },
      observers: [
        '_clearOldMetadata(route.path)'
      ],

      _clearOldMetadata: function() {
        this.metadata = null;
      },

      _computeParams: function(apiKey, id, secret) {
        return {
          method: 'flickr.photos.getInfo',
          api_key: apiKey,
          photo_id: id,
          secret: secret,
          format: 'json',
          nojsoncallback: 1
        };
      },

      _computeSrc: function(photo) {
        if (!photo || !photo.farm) {
          return '';
        }
        return 'https://farm' + photo.farm + '.staticflickr.com/' + photo.server + '/' + photo.id + '_' + photo.secret + '.jpg';
      }
    })
  </script>
</dom-module>

<dom-module id="flickr-search-demo">
  <template>
    <style>
      a {
        text-decoration: none;
        color: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
    <carbon-location route="{{route}}" use-hash-as-path></carbon-location>
    <carbon-route route="{{route}}" pattern="/:page" data="{{data}}">
    </carbon-route>
    <carbon-route route="{{route}}" pattern="/search" tail="{{searchRoute}}">
    </carbon-route>
    <carbon-route route="{{route}}" pattern="/image" tail="{{imageRoute}}">
    </carbon-route>

    <h1><a href="#/search/">Public Domain Image Search</a></h1>

    <iron-pages attr-for-selected="id" selected="{{data.page}}" selected-attribute="selected">
      <flickr-search-page id="search" api-key="{{apiKey}}" route="{{searchRoute}}">
      </flickr-search-page>
      <flickr-image-page id="image" api-key="{{apiKey}}" route="{{imageRoute}}">
      </flickr-search-page>
    </iron-pages>
  </template>
  <script>
    Polymer({
      is: 'flickr-search-demo',
      properties: {
        apiKey: {
          type: String,
          value: '5358d9830b6865a13d251e5e1acb4c30'
        }
      },

      attached: function() {
        this.async(function() {
          if (this.route.path === '') {
            this.set('route.path', '/search/');
          }
        });
      }
    });
  </script>
</dom-module>
